workflows:
  version: 2
  build:
    jobs:
      - build:
          filters:
            branches:
              only:
                - main
      - deploy:
          filters:
            branches:
              only:
                - main
          requires:
            - build

#IMPORTANT
orbs:
  ruby: circleci/ruby@1.4.0
 
jobs:
  build:
    working_directory: ~/Pablos_school
    docker:
      - image: cimg/ruby:3.1.0
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: docker-login
          command: docker login -u $DOCKERHUB_USERNAME -p $DOCKERHUB_PASSWORD
      - run:
          name: build-docker-image
          command: docker build -t $IMAGE_NAME . --build-arg SECRET_KEY_BASE=$SECRET_KEY_BASE 
      - run:
          name: publish-docker-image
          command: docker push $IMAGE_NAME
      - run:
          name: run-docker-image
          command: docker run -p 3000:3000 -d $IMAGE_NAME
  deploy:
    docker:
      - image: cimg/ruby:3.1.0
    steps:
      - run:
          name: deploy-application
          # added github token variable to access my github repo as it is private
          command: ssh -o StrictHostKeyChecking=no $EC2_USERNAME@$EC2_PUBLIC_DNS "export CONTAINER_NAME=\"$CONTAINER_NAME\"; export IMAGE_NAME=\"$IMAGE_NAME\"; rm -rf Pablos_school/; git clone https://github.com/PMM217/Pablos_School.git; source Pablos_School/deploy.sh"


































# version: 2.1
 
# orbs:
#   ruby: circleci/ruby@2.0.1
 
# jobs:
 
#   build-docker-image:
#     docker:
#       - image: cimg/docker:20.10
#     steps:
#       - checkout
#       - setup_remote_docker:
#           version: 20.10.24
#       - run:
#           name: Build Docker Image
#           command: |
#             docker build -t paulmurphy20/school_image:v1.0.0 .
#       - run:
#           name: Push Docker Image
#           command: |
#             echo $DOCKERHUB_PASSWORD | docker login -u $DOCKERHUB_USERNAME --password-stdin
#             docker push paulmurphy20/school_image:v1.0.0
 
#   deploy:
#     docker:
#       - image: cimg/base:stable
#     steps:
#       - run:
#           name: Deploy Application
#           command: echo "Deploying the application..."
 
# workflows:
#   build-and-deploy:
#     jobs:
#       - build-docker-image
#       - deploy:
#           requires:
#             - build-docker-image